#
# Huawei Access Switch Configuration - Phase 1 MVP
# Generated by: {{ template_name | default('access_switch.j2') }}
# Generated at: {{ generation_time | default('2025-09-01 12:00:00') }}
# Device: {{ hostname | default('ACCESS-SW-01') }}
# Role: Access Switch - End User Connectivity with PoE and Basic Security
#
<HUAWEI>
system-view

# System Identification
sysname {{ hostname | default('ACCESS-SW-01') }}

# VLAN Configuration for Access Switch
vlan batch {{ mgmt_vlan | default(10) }}{% if port_config is defined %}{% for port_range, config in port_config.items() %}{% if config.vlan is defined %} {{ config.vlan }}{% endif %}{% endfor %}{% else %} 100 101{% endif %}

# Management VLAN
vlan {{ mgmt_vlan | default(10) }}
 description "Management Network"
 quit

{% if port_config is defined %}
{% for port_range, config in port_config.items() %}
{% if config.vlan is defined and config.vlan != (mgmt_vlan | default(10)) %}
# VLAN {{ config.vlan }} for {{ config.description | default('Department') }}
vlan {{ config.vlan }}
 description "{{ config.description | default('Department VLAN') }}"
 quit

{% endif %}
{% endfor %}
{% else %}
# Default Department VLANs
vlan 100
 description "Marketing Department"
 quit

vlan 101
 description "Sales Department"
 quit
{% endif %}

# Access Port Configuration
{% if port_config is defined %}
{% for port_range, config in port_config.items() %}
{% if config.mode is not defined or config.mode != 'trunk' %}
# {{ config.description | default('Port Range: ' + port_range) }}
{% if '-' in port_range %}
{% set start_port, end_port = port_range.split('-') %}
interface range GigabitEthernet 0/0/{{ start_port }} to GigabitEthernet 0/0/{{ end_port }}
{% else %}
interface GigabitEthernet 0/0/{{ port_range }}
{% endif %}
 description "{{ config.description | default('Access Port') }}"
 port link-type access
 port default vlan {{ config.vlan | default(mgmt_vlan | default(10)) }}
{% if config.poe is defined and config.poe %}
 poe enable
{% endif %}
{% if config.port_security is defined and config.port_security %}
 port-security enable
 port-security max-mac-num 2
 port-security protect-action restrict
{% endif %}
 undo shutdown
 quit

{% endif %}
{% endfor %}
{% else %}
# Default Port Configuration
# Marketing Ports (1-8)
interface range GigabitEthernet 0/0/1 to GigabitEthernet 0/0/8
 description "Marketing Department"
 port link-type access
 port default vlan 100
 poe enable
 port-security enable
 port-security max-mac-num 2
 undo shutdown
 quit

# Sales Ports (9-16)
interface range GigabitEthernet 0/0/9 to GigabitEthernet 0/0/16
 description "Sales Department"
 port link-type access
 port default vlan 101
 poe enable
 port-security enable
 port-security max-mac-num 2
 undo shutdown
 quit

# Unused Ports (17-22)
interface range GigabitEthernet 0/0/17 to GigabitEthernet 0/0/22
 description "Unused Access Ports"
 port link-type access
 port default vlan {{ mgmt_vlan | default(10) }}
 shutdown
 quit
{% endif %}

# Trunk Port Configuration (Uplinks to Core)
{% if port_config is defined %}
{% for port_range, config in port_config.items() %}
{% if config.mode is defined and config.mode == 'trunk' %}
# {{ config.description | default('Trunk Uplink') }}
{% if '-' in port_range %}
{% set start_port, end_port = port_range.split('-') %}
interface range GigabitEthernet 0/0/{{ start_port }} to GigabitEthernet 0/0/{{ end_port }}
{% else %}
interface GigabitEthernet 0/0/{{ port_range }}
{% endif %}
 description "{{ config.description | default('Trunk to Core') }}"
 port link-type trunk
 port trunk allow-pass vlan {{ config.native_vlan | default(mgmt_vlan | default(10)) }}{% for pr, pc in port_config.items() %}{% if pc.vlan is defined and pc.vlan != (mgmt_vlan | default(10)) %} {{ pc.vlan }}{% endif %}{% endfor %}
 port trunk pvid vlan {{ config.native_vlan | default(mgmt_vlan | default(10)) }}
 stp edged-port disable
 undo shutdown
 quit

{% endif %}
{% endfor %}
{% else %}
# Default Uplink Configuration (Ports 23-24)
interface range GigabitEthernet 0/0/23 to GigabitEthernet 0/0/24
 description "Uplinks to Core Switches"
 port link-type trunk
 port trunk allow-pass vlan {{ mgmt_vlan | default(10) }} 100 101
 port trunk pvid vlan {{ mgmt_vlan | default(10) }}
 stp edged-port disable
 undo shutdown
 quit
{% endif %}

# Management Interface
interface Vlanif{{ mgmt_vlan | default(10) }}
 description "Management Interface"
 ip address {{ management_ip | default('192.168.10.13') }} 255.255.255.0
 quit

# STP Configuration
stp enable
stp mode {{ stp.mode | default('rstp') }}
stp priority {{ stp.priority | default(32768) }}

# Enable STP on all VLANs
{% if port_config is defined %}
{% set vlan_list = [] %}
{% for port_range, config in port_config.items() %}
{% if config.vlan is defined %}
{% set _ = vlan_list.append(config.vlan) %}
{% endif %}
{% endfor %}
stp instance 0 vlan {{ mgmt_vlan | default(10) }}{% for vlan in vlan_list | unique %} {{ vlan }}{% endfor %}
{% else %}
stp instance 0 vlan {{ mgmt_vlan | default(10) }} 100 101
{% endif %}

# PoE Configuration (if supported)
{% if features is defined and 'poe' in features %}
# Global PoE Settings
poe power-management slot 0
poe legacy enable
{% endif %}

# Basic Security Features
{% if features is defined and 'basic_port_security' in features %}
# Port Security Global Settings
port-security enable
am isolate

# Storm Control
storm-suppression broadcast 1000
storm-suppression multicast 1000
storm-suppression unicast 1000
{% endif %}

# SSH Configuration
ssh server enable
ssh server-source all-interface
ssh user admin authentication-type password
ssh user admin service-type all

# User Configuration
aaa
 local-user admin password irreversible-cipher $1c$q)5K&<l8$JsJkT5wR9qJ5l7M0Q2nR3p$
 local-user admin privilege level 15
 local-user admin service-type ssh
 quit

# SNMP Configuration
snmp-agent
snmp-agent community read public
snmp-agent sys-info version all

# Basic QoS for PoE Devices (Voice Priority)
{% if features is defined and 'poe' in features %}
# Voice VLAN Configuration (if needed)
traffic classifier voice-class operator and
 if-match 8021p 5
traffic behavior voice-behavior
 remark 8021p 5
traffic policy voice-policy
 classifier voice-class behavior voice-behavior
{% endif %}

# System Settings
clock timezone UTC add 00:00:00
info-center enable
info-center timestamp log date

# Save Configuration
return
save

#
# Access Switch Configuration Complete
# Management IP: {{ management_ip | default('192.168.10.13') }}
# PoE Enabled: {{ 'Yes' if features is defined and 'poe' in features else 'No' }}
# Port Security: {{ 'Enabled' if features is defined and 'basic_port_security' in features else 'Basic' }}
# Uplink VLANs: {{ mgmt_vlan | default(10) }}{% if port_config is defined %}{% for pr, pc in port_config.items() %}{% if pc.vlan is defined and pc.vlan != (mgmt_vlan | default(10)) %}, {{ pc.vlan }}{% endif %}{% endfor %}{% else %}, 100, 101{% endif %}
# Features: {{ features | join(', ') if features is defined else 'poe, basic_port_security, access_ports' }}
#
