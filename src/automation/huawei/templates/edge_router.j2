#
# Huawei Edge Router Configuration - Phase 1 MVP
# Generated by: {{ template_name | default('edge_router.j2') }}
# Generated at: {{ generation_time | default('2025-09-01 12:00:00') }}
# Device: {{ hostname | default('EDGE-ROUTER-01') }}
# Role: Edge Router - WAN Connectivity, OSPF, and Basic NAT
#
<HUAWEI>
system-view

# System Identification
sysname {{ hostname | default('EDGE-ROUTER-01') }}

# Interface Configuration
{% if interfaces is defined and interfaces | length > 0 %}
{% for interface_name, interface_config in interfaces.items() %}
# {{ interface_config.description | default('Interface ' + interface_name) }}
interface {{ interface_name }}
 description "{{ interface_config.description | default('Interface ' + interface_name) }}"
{% if interface_config.ip_address is defined and interface_config.subnet_mask is defined %}
 ip address {{ interface_config.ip_address }} {{ interface_config.subnet_mask }}
{% endif %}
{% if interface_config.shutdown is defined and interface_config.shutdown %}
 shutdown
{% else %}
 undo shutdown
{% endif %}
 quit

{% endfor %}
{% else %}
# Default Interface Configuration
interface GigabitEthernet0/0/1
 description "WAN Interface to ISP"
 ip address 203.0.113.10 255.255.255.252
 undo shutdown
 quit

interface GigabitEthernet0/0/2
 description "LAN Interface to Core Network"
 ip address 192.168.10.254 255.255.255.0
 undo shutdown
 quit
{% endif %}

# OSPF Configuration for Internal Routing
{% if routing is defined and routing.ospf is defined %}
ospf {{ routing.ospf.process_id | default(1) }}
 router-id {{ routing.ospf.router_id | default(management_ip | default('192.168.10.15')) }}
 area {{ routing.ospf.area | default(0) }}
{% if routing.ospf.networks is defined %}
{% for network in routing.ospf.networks %}
  network {{ network }}
{% endfor %}
{% else %}
  network 192.168.10.0 0.0.0.255
{% endif %}
 quit
{% else %}
# Default OSPF Configuration
ospf 1
 router-id {{ management_ip | default('192.168.10.15') }}
 area 0
  network 192.168.10.0 0.0.0.255
  network 192.168.100.0 0.0.0.255
  network 192.168.101.0 0.0.0.255
  network 192.168.102.0 0.0.0.255
  network 192.168.103.0 0.0.0.255
 quit
{% endif %}

# Static Routes Configuration
{% if routing is defined and routing.static_routes is defined %}
{% for route in routing.static_routes %}
# {{ route.description | default('Static Route') }}
ip route-static {{ route.destination | default('0.0.0.0/0') | replace('/32', ' 255.255.255.255') | replace('/24', ' 255.255.255.0') | replace('/0', ' 0.0.0.0') }} {{ route.next_hop }}
{% endfor %}
{% else %}
# Default Route to ISP
ip route-static 0.0.0.0 0.0.0.0 203.0.113.9
{% endif %}

# NAT Configuration for Internet Access
{% if nat is defined %}
# NAT Pool Configuration
{% if nat.pool is defined %}
nat address-group {{ nat.pool.name | default('NAT_POOL') }}
 section 0 {{ nat.pool.start_ip | default('203.0.113.10') }} {{ nat.pool.end_ip | default('203.0.113.10') }}
 quit
{% endif %}

# NAT Rules
acl number 2000
 description "Internal Networks for NAT"
{% if routing is defined and routing.ospf is defined and routing.ospf.networks is defined %}
{% for network in routing.ospf.networks %}
 rule 10 permit source {{ network | replace('/', ' ') | replace('.0 0.0.0.255', '.0 0.0.0.255') }}
{% endfor %}
{% else %}
 rule 10 permit source 192.168.10.0 0.0.0.255
 rule 20 permit source 192.168.100.0 0.0.0.255
 rule 30 permit source 192.168.101.0 0.0.0.255
 rule 40 permit source 192.168.102.0 0.0.0.255
 rule 50 permit source 192.168.103.0 0.0.0.255
{% endif %}
 quit

# Apply NAT on Interfaces
{% for interface_name in nat.inside_interfaces | default(['GigabitEthernet0/0/2']) %}
interface {{ interface_name }}
 nat outbound 2000
 quit
{% endfor %}

{% for interface_name in nat.outside_interfaces | default(['GigabitEthernet0/0/1']) %}
interface {{ interface_name }}
 nat outbound 2000
 quit
{% endfor %}

{% else %}
# Default NAT Configuration
acl number 2000
 description "Internal Networks for NAT"
 rule 10 permit source 192.168.0.0 0.0.255.255
 quit

interface GigabitEthernet0/0/1
 nat outbound 2000
 quit
{% endif %}

# Firewall and Security Configuration
{% if features is defined and 'simple_acls' in features %}
# Basic Security ACLs
acl number 3001
 description "Inbound Internet Security"
 rule 10 deny tcp destination-port eq 135
 rule 20 deny tcp destination-port eq 139  
 rule 30 deny tcp destination-port eq 445
 rule 40 deny udp destination-port eq 135
 rule 50 deny udp destination-port eq 137
 rule 60 deny udp destination-port eq 138
 rule 70 permit ip
 quit

# Apply Security ACL on WAN Interface
{% if interfaces is defined %}
{% for interface_name, interface_config in interfaces.items() %}
{% if 'WAN' in interface_config.description | default('') or 'wan' in interface_name.lower() %}
interface {{ interface_name }}
 traffic-filter inbound acl 3001
 quit
{% endif %}
{% endfor %}
{% else %}
interface GigabitEthernet0/0/1
 traffic-filter inbound acl 3001
 quit
{% endif %}
{% endif %}

# Basic QoS for WAN Optimization
{% if features is defined and 'basic_qos' in features %}
# Traffic Classification
traffic classifier critical-class operator and
 if-match acl 3002
traffic classifier normal-class operator and
 if-match any

# Traffic Behavior
traffic behavior critical-behavior
 permit
 remark dscp af31
traffic behavior normal-behavior
 permit

# Traffic Policy
traffic policy wan-qos
 classifier critical-class behavior critical-behavior
 classifier normal-class behavior normal-behavior
 quit

# QoS ACL for Critical Traffic
acl number 3002
 description "Critical Business Traffic"
 rule 10 permit tcp destination-port eq 80
 rule 20 permit tcp destination-port eq 443
 rule 30 permit tcp destination-port eq 22
 quit
{% endif %}

# SSH Configuration
ssh server enable
ssh server-source all-interface
ssh user admin authentication-type password
ssh user admin service-type all

# User Configuration
aaa
 local-user admin password irreversible-cipher $1c$q)5K&<l8$JsJkT5wR9qJ5l7M0Q2nR3p$
 local-user admin privilege level 15
 local-user admin service-type ssh
 quit

# SNMP Configuration
snmp-agent
snmp-agent community read public
snmp-agent sys-info version all

# Logging and Monitoring
info-center enable
info-center timestamp log date
info-center loghost {{ management_ip | default('192.168.10.10') }}

# NTP Configuration (if available)
{% if ntp is defined %}
{% for ntp_server in ntp.servers | default(['pool.ntp.org']) %}
ntp-service unicast-server {{ ntp_server }}
{% endfor %}
ntp-service enable
{% endif %}

# System Settings
clock timezone UTC add 00:00:00

# Management Interface Configuration
{% if management_ip is defined %}
# Loopback for Management
interface LoopBack0
 description "Management Loopback"
 ip address {{ management_ip }} 255.255.255.255
 quit
{% endif %}

# Save Configuration
return
save

#
# Edge Router Configuration Complete
# WAN Interface: {{ interfaces['GigabitEthernet0/0/1'].ip_address if interfaces is defined and 'GigabitEthernet0/0/1' in interfaces else '203.0.113.10' }}
# LAN Interface: {{ interfaces['GigabitEthernet0/0/2'].ip_address if interfaces is defined and 'GigabitEthernet0/0/2' in interfaces else '192.168.10.254' }}
# OSPF Area: {{ routing.ospf.area | default(0) if routing is defined and routing.ospf is defined else 0 }}
# NAT: {{ 'Enabled' if nat is defined else 'Default Configuration' }}
# Features: {{ features | join(', ') if features is defined else 'ospf_routing, basic_nat, simple_acls' }}
#
